
{% extends "admin/base.html" %}

{% block title %}Salary Management - Admin{% endblock %}

{% block content %}
<div class="flex-1 p-6" style="background: linear-gradient(135deg, #87CEEB 0%, #E6F3FF 25%, #F8F9FA 50%, #FFE4E1 75%, #FFC0CB 100%) !important; min-height: 100vh;">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8 fade-in">
            <div>
                <h1 class="text-3xl font-bold text-black">ðŸ’° Monthly Salary Management</h1>
                <p class="text-gray-700">Manage automatic monthly salary payments</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right glass-card p-4 rounded-xl">
                    <div class="text-sm text-gray-700">Pending Requests</div>
                    <div class="text-2xl font-bold text-orange-600">{{ pending_requests|length }}</div>
                </div>
                <div class="text-right glass-card p-4 rounded-xl">
                    <div class="text-sm text-gray-700">This Month Paid</div>
                    <div class="text-2xl font-bold text-green-600">{{ paid_this_month|length }}</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 rounded-xl text-center transform hover:scale-105 transition-all duration-300">
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-white text-lg font-bold">1</span>
                </div>
                <h3 class="text-lg font-bold text-black">Basic Plan</h3>
                <p class="text-green-600 font-semibold">$50/month</p>
                <p class="text-gray-600 text-sm">7 refs, $350 balance</p>
            </div>
            
            <div class="glass-card p-6 rounded-xl text-center transform hover:scale-105 transition-all duration-300">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-white text-lg font-bold">2</span>
                </div>
                <h3 class="text-lg font-bold text-black">Silver Plan</h3>
                <p class="text-blue-600 font-semibold">$110/month</p>
                <p class="text-gray-600 text-sm">13 refs, $680 balance</p>
            </div>
            
            <div class="glass-card p-6 rounded-xl text-center transform hover:scale-105 transition-all duration-300">
                <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-white text-lg font-bold">3</span>
                </div>
                <h3 class="text-lg font-bold text-black">Gold Plan</h3>
                <p class="text-yellow-600 font-semibold">$230/month</p>
                <p class="text-gray-600 text-sm">27 refs, $960 balance</p>
            </div>
            
            <div class="glass-card p-6 rounded-xl text-center transform hover:scale-105 transition-all duration-300">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-white text-lg font-bold">4</span>
                </div>
                <h3 class="text-lg font-bold text-black">Platinum Plan</h3>
                <p class="text-purple-600 font-semibold">$480/month</p>
                <p class="text-gray-600 text-sm">46 refs, $1340 balance</p>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="glass-card rounded-xl shadow-lg mb-8 slide-up">
            <div class="p-6 border-b border-gray-200/20">
                <h2 class="text-xl font-semibold text-black flex items-center">
                    <i class="fas fa-clock text-orange-500 mr-3"></i>
                    Pending Salary Requests
                    <span class="ml-auto bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">{{ pending_requests|length }} pending</span>
                </h2>
            </div>
            
            {% if pending_requests %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-black font-medium">User Details</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Plan & Amount</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Wallet Address</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Request Date</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                        <tr class="border-b border-gray-100/50 hover:bg-gray-50/30 transition-all duration-200">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-black font-semibold">{{ request.user.username }}</p>
                                        <p class="text-gray-600 text-xs">{{ request.user.email }}</p>
                                        <p class="text-gray-500 text-xs">ID: {{ request.user.id }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-gradient-to-r from-{{ salary_plans[request.plan_id].color }}-500 to-{{ salary_plans[request.plan_id].color }}-600 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-white text-sm font-bold">{{ request.plan_id }}</span>
                                    </div>
                                    <div>
                                        <p class="text-black font-semibold">${{ request.amount }}</p>
                                        <p class="text-gray-600 text-xs">{{ salary_plans[request.plan_id].name }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="bg-gray-100 rounded-lg p-2">
                                    <p class="text-black font-mono text-xs">{{ request.wallet_address[:20] }}...</p>
                                    <button onclick="copyToClipboard('{{ request.wallet_address }}')" 
                                            class="text-blue-600 hover:text-blue-800 text-xs mt-1 transition-colors">
                                        <i class="fas fa-copy mr-1"></i>Copy Full
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <p class="text-black font-medium">{{ request.created_at.strftime('%d %b %Y') }}</p>
                                <p class="text-gray-600 text-xs">{{ request.created_at.strftime('%H:%M') }}</p>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex space-x-2">
                                    <button onclick="quickApprove({{ request.id }})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-medium transform hover:scale-105 transition-all duration-200">
                                        <i class="fas fa-check mr-1"></i>Approve
                                    </button>
                                    <button onclick="quickReject({{ request.id }})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-medium transform hover:scale-105 transition-all duration-200">
                                        <i class="fas fa-times mr-1"></i>Reject
                                    </button>
                                    <a href="{{ url_for('admin_process_salary_request', request_id=request.id) }}" 
                                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-medium transform hover:scale-105 transition-all duration-200">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-12 text-center">
                <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-inbox text-gray-500 text-2xl"></i>
                </div>
                <p class="text-gray-600 text-lg">No pending salary requests</p>
                <p class="text-gray-500 text-sm">All caught up! ðŸŽ‰</p>
            </div>
            {% endif %}
        </div>

        <!-- Recently Processed -->
        <div class="glass-card rounded-xl shadow-lg slide-up">
            <div class="p-6 border-b border-gray-200/20">
                <h2 class="text-xl font-semibold text-black flex items-center">
                    <i class="fas fa-history text-green-500 mr-3"></i>
                    Recently Processed
                </h2>
            </div>
            
            {% if processed_requests %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-black font-medium">User</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Amount</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Status</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Processed</th>
                            <th class="px-6 py-4 text-left text-black font-medium">Transaction</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in processed_requests[:10] %}
                        <tr class="border-b border-gray-100/50 hover:bg-gray-50/30 transition-all duration-200">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-white text-xs"></i>
                                    </div>
                                    <span class="text-black font-medium">{{ request.user.username }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-black font-bold">${{ request.amount }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {% if request.status == 'approved' %}
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-medium">
                                    <i class="fas fa-check mr-1"></i>APPROVED
                                </span>
                                {% else %}
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium">
                                    <i class="fas fa-times mr-1"></i>REJECTED
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <p class="text-black">{{ request.processed_at.strftime('%d %b') }}</p>
                            </td>
                            <td class="px-6 py-4">
                                {% if request.transaction_hash %}
                                <span class="text-blue-600 font-mono text-xs">{{ request.transaction_hash[:10] }}...</span>
                                {% else %}
                                <span class="text-gray-500">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center">
                <p class="text-gray-600">No processed requests yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="salaryLoadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-md z-50 flex items-center justify-center hidden">
    <div class="glass-card p-8 rounded-2xl text-center max-w-sm mx-4">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
        <h3 class="text-xl font-bold text-black mb-2">Processing...</h3>
        <p class="text-gray-700" id="loadingMessage">Please wait while we process your request</p>
    </div>
</div>

<script>
// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Wallet address copied!', 'success');
    });
}

// Quick approve function
function quickApprove(requestId) {
    showLoading('Approving salary request...', 'This may take a few moments');
    
    const txHash = prompt('Enter transaction hash:');
    if (!txHash) {
        hideLoading();
        return;
    }
    
    fetch(`/admin/salary-requests/${requestId}/quick-approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            transaction_hash: txHash
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification('Salary request approved successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message || 'Error approving request', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Network error occurred', 'error');
    });
}

// Quick reject function
function quickReject(requestId) {
    if (!confirm('Are you sure you want to reject this salary request?')) return;
    
    showLoading('Rejecting salary request...', 'Processing your action');
    
    fetch(`/admin/salary-requests/${requestId}/quick-reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification('Salary request rejected', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message || 'Error rejecting request', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Network error occurred', 'error');
    });
}

// Show loading overlay
function showLoading(title, message) {
    const overlay = document.getElementById('salaryLoadingOverlay');
    const messageEl = document.getElementById('loadingMessage');
    if (messageEl) messageEl.textContent = message;
    overlay.classList.remove('hidden');
}

// Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('salaryLoadingOverlay');
    overlay.classList.add('hidden');
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Add smooth animations on page load
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.glass-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.fade-in {
    animation: fadeIn 0.6s ease-out;
}

.slide-up {
    animation: slideUp 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Smooth transitions for all interactive elements */
button, a, .glass-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

button:hover, a:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

/* Performance optimizations */
* {
    will-change: auto;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
</style>
{% endblock %}
