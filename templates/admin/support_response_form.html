{% extends "admin/base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex items-center mb-6">
        <a href="{{ url_for('support_responses.admin_support_responses') }}" 
           class="text-blue-600 hover:text-blue-800 mr-4">
            <i class="fas fa-arrow-left mr-2"></i>Back to Responses
        </a>
        <h1 class="text-3xl font-bold text-black">
            {% if response %}Edit{% else %}Add New{% endif %} Support Response
        </h1>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-lg p-6">
        <form method="POST">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <div>
                        <label for="trigger_words" class="block text-sm font-medium text-gray-700 mb-2">
                            Trigger Words *
                        </label>
                        <input type="text" 
                               id="trigger_words" 
                               name="trigger_words" 
                               value="{{ response.trigger_words if response else '' }}"
                               placeholder="account, balance, summary, my account"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Comma-separated words that will trigger this response</p>
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                            Category
                        </label>
                        <select id="category" 
                                name="category" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="general" {% if response and response.category == 'general' %}selected{% endif %}>General</option>
                            <option value="account" {% if response and response.category == 'account' %}selected{% endif %}>Account</option>
                            <option value="staking" {% if response and response.category == 'staking' %}selected{% endif %}>Staking</option>
                            <option value="deposit" {% if response and response.category == 'deposit' %}selected{% endif %}>Deposit</option>
                            <option value="withdrawal" {% if response and response.category == 'withdrawal' %}selected{% endif %}>Withdrawal</option>
                            <option value="referral" {% if response and response.category == 'referral' %}selected{% endif %}>Referral</option>
                        </select>
                    </div>

                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                            Priority
                        </label>
                        <input type="number" 
                               id="priority" 
                               name="priority" 
                               value="{{ response.priority if response else 0 }}"
                               min="0" 
                               max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Higher numbers are checked first (0 = lowest priority)</p>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="is_active" 
                               name="is_active" 
                               {% if not response or response.is_active %}checked{% endif %}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="is_active" class="ml-2 block text-sm text-gray-700">
                            Active (Response will be used in chat)
                        </label>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <div>
                        <label for="response_text" class="block text-sm font-medium text-gray-700 mb-2">
                            Response Text *
                        </label>
                        <textarea id="response_text" 
                                  name="response_text" 
                                  rows="12"
                                  placeholder="### Welcome to Account Summary<br><br>Your current balance is $500.00<br>• Active Stakes: 2<br>• Total Earnings: $45.30"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  required>{{ response.response_text if response else '' }}</textarea>
                        <p class="text-xs text-gray-500 mt-1">HTML formatting supported. Use &lt;br&gt; for line breaks, &lt;strong&gt; for bold text.</p>
                    </div>

                    <!-- Preview Section -->
                    <div class="border-t pt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Live Preview</h3>
                        <div id="preview" class="bg-gray-50 border rounded-lg p-4 min-h-32">
                            <div class="text-sm text-gray-500">
                                Type in the response text above to see a live preview...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between items-center mt-8 pt-6 border-t">
                <a href="{{ url_for('support_responses.admin_support_responses') }}" 
                   class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
                <button type="submit" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    {% if response %}Update Response{% else %}Create Response{% endif %}
                </button>
            </div>
        </form>
    </div>

    <!-- Quick Reference -->
    <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">
            <i class="fas fa-lightbulb mr-2"></i>Quick Reference
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-yellow-700">
            <div>
                <strong>Common Trigger Words:</strong>
                <ul class="list-disc list-inside space-y-1 mt-1">
                    <li>Account: balance, summary, account, profile</li>
                    <li>Staking: stake, staking, earn, rewards</li>
                    <li>Deposit: deposit, add money, fund</li>
                    <li>Withdrawal: withdraw, cash out, money out</li>
                </ul>
            </div>
            <div>
                <strong>HTML Formatting Examples:</strong>
                <ul class="list-disc list-inside space-y-1 mt-1">
                    <li>&lt;strong&gt;Bold text&lt;/strong&gt;</li>
                    <li>&lt;br&gt; for line breaks</li>
                    <li>### for large headers</li>
                    <li>• for bullet points</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Live preview functionality
document.getElementById('response_text').addEventListener('input', function() {
    const text = this.value;
    const preview = document.getElementById('preview');
    
    if (text.trim()) {
        // Convert common formats to HTML
        let formatted = text
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/### (.*?)(?=<br>|$)/g, '<div class="text-lg font-bold text-blue-600 mb-2">$1</div>')
            .replace(/#### (.*?)(?=<br>|$)/g, '<div class="text-md font-semibold text-purple-600 mb-1">$1</div>')
            .replace(/• (.*?)(?=<br>|$)/g, '<div class="flex items-start space-x-2 mb-1"><div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div><div>$1</div></div>');
        
        preview.innerHTML = `<div class="text-sm text-gray-700">${formatted}</div>`;
    } else {
        preview.innerHTML = '<div class="text-sm text-gray-500">Type in the response text above to see a live preview...</div>';
    }
});

// Initialize preview if editing
window.addEventListener('load', function() {
    const responseText = document.getElementById('response_text');
    if (responseText.value.trim()) {
        responseText.dispatchEvent(new Event('input'));
    }
});
</script>
{% endblock %}