{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-2 py-4 max-w-full md:max-w-6xl md:px-4 md:py-6">
    <!-- Premium Header -->
    <div class="text-center mb-4 md:mb-8">
        <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4 shadow-2xl animate-pulse">
            <i class="fas fa-crown text-white text-xl md:text-2xl"></i>
        </div>
        <h1 class="text-2xl md:text-3xl font-bold text-black mb-2">Premium Elite Support</h1>
        <p class="text-gray-700 text-sm md:text-base px-4">AI-Powered Instant Support with Step-by-Step Guidance</p>
        <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4 mt-3 md:mt-4">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs md:text-sm text-green-600 font-semibold">AI Support Online</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                <span class="text-xs md:text-sm text-blue-600 font-semibold">Expert Team Available</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-8">
        <!-- Main Chat Interface -->
        <div class="lg:col-span-2 order-2 lg:order-1">
            <div class="glass-card rounded-xl lg:rounded-2xl shadow-2xl overflow-hidden">
                <!-- Enhanced Chat Header -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-4 lg:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 lg:w-12 lg:h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i class="fas fa-robot text-white text-sm lg:text-base"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-base lg:text-lg">Premium AI Assistant</h3>
                                <p class="text-xs lg:text-sm opacity-90 hidden sm:block">Powered by Advanced Intelligence • Instant Responses</p>
                                <p class="text-xs opacity-90 sm:hidden">AI Support</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <div class="flex items-center space-x-1 lg:space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-xs font-medium">Online</span>
                            </div>
                            <button onclick="clearChat()" class="text-white/80 hover:text-white transition-colors p-1">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="h-64 sm:h-80 lg:h-96 overflow-y-auto p-3 lg:p-6 space-y-3 lg:space-y-4 bg-white">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-2 lg:space-x-3 opacity-0 animate-fade-in">
                        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-crown text-white text-xs lg:text-sm"></i>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg lg:rounded-xl p-3 lg:p-4 max-w-xs sm:max-w-sm lg:max-w-md border border-blue-200">
                            <p class="text-black font-medium mb-2 text-sm lg:text-base">🎉 Welcome to Premium Support, {{ current_user.username }}!</p>
                            <p class="text-xs lg:text-sm text-gray-700 mb-2 lg:mb-3">I'm your AI assistant with access to your complete account data. I provide step-by-step guidance for:</p>
                            <div class="text-xs space-y-1 text-gray-600">
                                <div>• Real-time account analysis</div>
                                <div>• Staking optimization strategies</div>
                                <div>• Transaction troubleshooting</div>
                                <div>• Investment planning guidance</div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Ask me anything - I'll provide detailed, step-by-step solutions!</p>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden p-3 lg:p-4 border-t border-gray-200">
                    <div class="flex items-center space-x-2 lg:space-x-3">
                        <div class="w-6 h-6 lg:w-8 lg:h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-xs lg:text-sm text-gray-600">AI Assistant is analyzing...</span>
                    </div>
                </div>

                <!-- Enhanced Message Input -->
                <div class="p-3 lg:p-6 border-t border-gray-200 bg-gray-50">
                    <div class="flex space-x-2 lg:space-x-4 mb-3 lg:mb-4">
                        <input type="text" 
                               id="messageInput" 
                               placeholder="Ask anything about your account..."
                               class="flex-1 bg-white border-2 border-gray-200 rounded-lg lg:rounded-xl px-3 lg:px-4 py-2 lg:py-3 text-gray-700 text-sm lg:text-base focus:outline-none focus:border-blue-400 transition-colors"
                               onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-3 lg:px-6 py-2 lg:py-3 rounded-lg lg:rounded-xl transition-all duration-300 font-medium text-sm lg:text-base">
                            <i class="fas fa-paper-plane lg:mr-2"></i>
                            <span class="hidden lg:inline">Send</span>
                        </button>
                    </div>
                    
                    <!-- Quick Action Buttons -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                        <button onclick="sendQuickMessage('Show my complete account summary')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 lg:px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="fas fa-chart-pie mr-1"></i>
                            <span class="hidden sm:inline">Account </span>Summary
                        </button>
                        <button onclick="sendQuickMessage('Analyze my stake performance step by step')" class="bg-green-100 hover:bg-green-200 text-green-800 px-2 lg:px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="fas fa-chart-line mr-1"></i>
                            <span class="hidden sm:inline">Stake </span>Analysis
                        </button>
                        <button onclick="sendQuickMessage('Guide me through deposit process')" class="bg-purple-100 hover:bg-purple-200 text-purple-800 px-2 lg:px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="fas fa-plus-circle mr-1"></i>
                            <span class="hidden sm:inline">Deposit </span>Guide
                        </button>
                        <button onclick="sendQuickMessage('Help me optimize my investment strategy')" class="bg-orange-100 hover:bg-orange-200 text-orange-800 px-2 lg:px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="fas fa-brain mr-1"></i>
                            <span class="hidden sm:inline">Strategy </span>Help
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Sidebar -->
        <div class="space-y-4 lg:space-y-6 order-1 lg:order-2">
            <!-- Account Status -->
            <div class="glass-card p-4 lg:p-6 rounded-xl">
                <h3 class="font-bold text-black mb-3 lg:mb-4 text-sm lg:text-base">
                    <i class="fas fa-user-crown text-purple-500 mr-2"></i>Premium Account Status
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs lg:text-sm text-gray-700">Account Type</span>
                        <span class="text-xs lg:text-sm font-semibold text-purple-600">Elite Member</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs lg:text-sm text-gray-700">Support Level</span>
                        <span class="text-xs lg:text-sm font-semibold text-gold">Premium</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs lg:text-sm text-gray-700">Response Time</span>
                        <span class="text-xs lg:text-sm font-semibold text-green-600">Instant</span>
                    </div>
                </div>
            </div>

            <!-- Live Account Stats -->
            <div class="glass-card p-4 lg:p-6 rounded-xl">
                <h3 class="font-bold text-black mb-3 lg:mb-4 text-sm lg:text-base">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>Live Account Stats
                </h3>
                <div class="space-y-2 lg:space-y-3 text-xs lg:text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Total Balance</span>
                        <span class="font-semibold text-green-600">${{ '%.2f'|format(current_user.usdt_balance) }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Active Stakes</span>
                        <span class="font-semibold text-blue-600">{{ current_user.stakes|length }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Total Earnings</span>
                        <span class="font-semibold text-purple-600">${{ '%.2f'|format(current_user.total_earned) }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Referrals</span>
                        <span class="font-semibold text-orange-600">{{ current_user.get_referral_count() }}</span>
                    </div>
                </div>
            </div>

            <!-- Premium Features -->
            <div class="glass-card p-4 lg:p-6 rounded-xl">
                <h3 class="font-bold text-black mb-3 lg:mb-4 text-sm lg:text-base">
                    <i class="fas fa-star text-gold mr-2"></i>Premium Features
                </h3>
                <div class="space-y-2 lg:space-y-3 text-xs lg:text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-gray-700">AI-Powered Analysis</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-gray-700">Step-by-Step Guidance</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-gray-700">Real-time Data Access</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-gray-700">Priority Support Queue</span>
                    </div>
                </div>
            </div>

            <!-- Help Topics -->
            <div class="glass-card p-4 lg:p-6 rounded-xl">
                <h3 class="font-bold text-black mb-3 lg:mb-4 text-sm lg:text-base">
                    <i class="fas fa-question-circle text-blue-500 mr-2"></i>Popular Help Topics
                </h3>
                <div class="space-y-2">
                    <button onclick="sendQuickMessage('How to maximize my staking returns?')" class="w-full text-left p-2 hover:bg-blue-50 rounded-lg text-xs lg:text-sm text-gray-700 transition-colors">
                        Maximize Returns
                    </button>
                    <button onclick="sendQuickMessage('Explain withdrawal process step by step')" class="w-full text-left p-2 hover:bg-blue-50 rounded-lg text-xs lg:text-sm text-gray-700 transition-colors">
                        Withdrawal Guide
                    </button>
                    <button onclick="sendQuickMessage('Best staking strategy for my balance')" class="w-full text-left p-2 hover:bg-blue-50 rounded-lg text-xs lg:text-sm text-gray-700 transition-colors">
                        Strategy Planning
                    </button>
                    <button onclick="sendQuickMessage('Check my referral program performance')" class="w-full text-left p-2 hover:bg-blue-50 rounded-lg text-xs lg:text-sm text-gray-700 transition-colors">
                        Referral Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
        animation: fade-in 0.5s ease-out forwards;
    }
    
    .text-gold {
        color: #D4AF37;
    }
    
    .glass-card {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        #chatMessages {
            height: 50vh !important;
        }
        
        .glass-card {
            backdrop-filter: blur(10px);
        }
        
        /* Better touch targets */
        button {
            min-height: 44px;
        }
        
        /* Optimize scrolling */
        #chatMessages {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
    }
    
    /* Very small screens */
    @media (max-width: 480px) {
        #chatMessages {
            height: 45vh !important;
        }
        
        .container {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
    }
</style>

<script>
let messageCount = 0;

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message) {
        addUserMessage(message);
        input.value = '';
        showTypingIndicator();
        
        // Enhanced response with step-by-step processing
        setTimeout(() => {
            hideTypingIndicator();
            generateEnhancedResponse(message);
        }, 2000 + Math.random() * 3000);
    }
}

function sendQuickMessage(message) {
    addUserMessage(message);
    showTypingIndicator();
    
    setTimeout(() => {
        hideTypingIndicator();
        generateEnhancedResponse(message);
    }, 2000 + Math.random() * 3000);
}

function addUserMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-2 lg:space-x-3 justify-end opacity-0 animate-fade-in';
    
    messageDiv.innerHTML = `
        <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg lg:rounded-xl p-3 lg:p-4 max-w-xs sm:max-w-sm lg:max-w-md">
            <p class="text-xs lg:text-sm">${message}</p>
            <p class="text-xs opacity-75 mt-1">Just now</p>
        </div>
        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-gray-600 text-xs lg:text-sm"></i>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addSupportMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-3 opacity-0 animate-fade-in';
    
    // Enhanced formatting for step-by-step responses
    const formattedMessage = message
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-black">$1</strong>')
        .replace(/### (.*?)(?=<br>|$)/g, '<div class="text-lg font-bold text-blue-600 mb-2">$1</div>')
        .replace(/#### (.*?)(?=<br>|$)/g, '<div class="text-md font-semibold text-purple-600 mb-1">$1</div>')
        .replace(/• (.*?)(?=<br>|$)/g, '<div class="flex items-start space-x-2 mb-1"><div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div><div class="text-gray-700">$1</div></div>')
        .replace(/\$(\d+(?:\.\d+)?)/g, '<span class="text-green-600 font-semibold">$$1</span>')
        .replace(/(\d+(?:\.\d+)?%)/g, '<span class="text-blue-600 font-semibold">$1</span>')
        .replace(/✅/g, '<span class="text-green-500">✅</span>')
        .replace(/🎯/g, '<span class="text-blue-500">🎯</span>')
        .replace(/📊/g, '<span class="text-purple-500">📊</span>');
    
    messageDiv.innerHTML = `
        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-crown text-white text-xs lg:text-sm"></i>
        </div>
        <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg lg:rounded-xl p-3 lg:p-4 max-w-xs sm:max-w-sm lg:max-w-md border border-blue-200">
            <div class="text-xs lg:text-sm text-black">${formattedMessage}</div>
            <p class="text-xs text-gray-500 mt-2">Premium AI Assistant • Just now</p>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').classList.remove('hidden');
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('hidden');
}

function clearChat() {
    const messagesContainer = document.getElementById('chatMessages');
    const welcomeMessage = messagesContainer.querySelector('.opacity-0');
    messagesContainer.innerHTML = '';
    if (welcomeMessage) {
        messagesContainer.appendChild(welcomeMessage.cloneNode(true));
    }
}

function generateEnhancedResponse(userMessage) {
    const message = userMessage.toLowerCase();
    
    // Check for human support request first
    if (message.includes('human') || message.includes('live chat') || message.includes('speak to human') || message.includes('real person')) {
        addSupportMessage(`### 👨‍💼 Human Support Available<br><br>
                          **Connect with our live support team via Telegram:**<br><br>
                          🔗 **Telegram Support**: @USDTSTAKING_SUPPORT<br>
                          📱 **Direct Link**: <a href="https://t.me/USDTSTAKING_SUPPORT" target="_blank" class="text-blue-600 underline">t.me/USDTSTAKING_SUPPORT</a><br><br>
                          #### What our human agents can help with:<br>
                          • Complex technical issues<br>
                          • Account recovery assistance<br>
                          • Withdrawal priority processing<br>
                          • VIP customer escalations<br><br>
                          ⏱️ **Response Time**: Usually within 30 minutes during business hours (9 AM - 11 PM UTC)`);
        return;
    }
    
    // Try to get admin-managed response first
    fetch(`/api/support-response?message=${encodeURIComponent(userMessage)}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            // Use admin-managed response
            addSupportMessage(data.response);
        } else {
            // Use fallback default responses
            addSupportMessage(generateFallbackResponse(userMessage));
        }
    })
    .catch(error => {
        console.log('API error, using fallback:', error);
        // If API fails, use fallback
        addSupportMessage(generateFallbackResponse(userMessage));
    });
}

function generateFallbackResponse(userMessage) {
    const message = userMessage.toLowerCase();
    
    // Step-by-step detailed responses
    if (message.includes('account') || message.includes('summary') || message.includes('balance')) {
        return `### 📊 Complete Account Analysis<br><br>` +
               `**Current Status**: Elite Member with Premium Support<br><br>` +
               `#### Financial Overview:<br>` +
               `• Available Balance: ${{ '%.2f'|format(current_user.usdt_balance) }}<br>` +
               `• Total Invested: ${{ '%.2f'|format(current_user.total_staked) }}<br>` +
               `• Current Earnings: ${{ '%.2f'|format(current_user.total_earned) }}<br>` +
               `• Portfolio Growth: +{{ ((current_user.total_earned / current_user.usdt_balance * 100) if current_user.usdt_balance > 0 else 0)|round(1) }}%<br><br>` +
               `#### Active Investments:<br>` +
               `• Number of Stakes: {{ current_user.stakes|length }}<br>` +
               `• Average Daily Return: 1.5%<br>` +
               `• Estimated Monthly Income: $45.00<br><br>` +
               `#### Referral Program:<br>` +
               `• Total Referrals: {{ current_user.get_referral_count() }}<br>` +
               `• Premium Status: {% if current_user.get_referral_count() >= 2 %}✅ Activated{% else %}Pending (Need {{ 2 - current_user.get_referral_count() }} more){% endif %}<br><br>` +
               `🎯 **Next Steps**: Consider increasing your stake amount or diversifying across different coins for optimal returns!`;
    }
    
    if (message.includes('stake') || message.includes('staking') || message.includes('investment')) {
        return `### 🚀 Premium Staking Guide<br><br>` +
               `#### Step-by-Step Staking Process:<br>` +
               `• **Step 1**: Navigate to Stake section<br>` +
               `• **Step 2**: Choose your preferred cryptocurrency<br>` +
               `• **Step 3**: Select staking duration (7-365 days)<br>` +
               `• **Step 4**: Enter amount and confirm transaction<br><br>` +
               `#### Available Options:<br>` +
               `• **USDT**: 0.8-2.0% daily returns<br>` +
               `• **BTC**: 0.5-1.8% daily returns (Min: $250)<br>` +
               `• **ETH**: 0.7-1.9% daily returns (Min: $170)<br>` +
               `• **BNB**: 0.6-1.7% daily returns (Min: $90)<br><br>` +
               `💡 **Pro Tip**: Longer durations offer higher daily returns!`;
    }
    
    if (message.includes('deposit') || message.includes('add money') || message.includes('fund')) {
        return `### 💰 Comprehensive Deposit Guide<br><br>` +
               `#### Quick Deposit Steps:<br>` +
               `• **Step 1**: Go to Assets → Deposit<br>` +
               `• **Step 2**: Copy wallet address: **0xae49d3b4775c0524bd81da704340b5ef5a7416e9**<br>` +
               `• **Step 3**: Send USDT (BEP20 Network) to this address<br>` +
               `• **Step 4**: Submit transaction hash for verification<br><br>` +
               `#### Important Notes:<br>` +
               `• **Network**: Only BEP20 (Binance Smart Chain)<br>` +
               `• **Processing**: 5-15 minutes after blockchain confirmation<br>` +
               `• **Verification**: Real blockchain verification required<br><br>` +
               `✅ **Security**: All deposits are verified through BSC blockchain`;
    }
    
    if (message.includes('withdraw') || message.includes('cash out') || message.includes('payout')) {
        return `### 💸 Withdrawal Process Guide<br><br>` +
               `#### Step-by-Step Withdrawal:<br>` +
               `• **Step 1**: Go to Assets → Withdraw<br>` +
               `• **Step 2**: Enter withdrawal amount<br>` +
               `• **Step 3**: Provide your USDT wallet address<br>` +
               `• **Step 4**: Submit request for admin review<br><br>` +
               `#### Processing Information:<br>` +
               `• **Review Time**: 24-48 hours<br>` +
               `• **Fee**: 1% (Waived for 2+ referrals)<br>` +
               `• **Minimum**: $10.00<br><br>` +
               `🎁 **Pro Benefit**: Get 2+ referrals for zero withdrawal fees!`;
    }
    
    if (message.includes('referral') || message.includes('invite') || message.includes('bonus')) {
        return `### 👥 Advanced Referral System<br><br>` +
               `#### Commission Structure:<br>` +
               `• **Level 1**: 5% direct referral commission<br>` +
               `• **Level 2**: 3% second-level commission<br>` +
               `• **Level 3**: 2% third-level commission<br><br>` +
               `#### Premium Benefits (2+ Referrals):<br>` +
               `• **Bonus**: $20 instant bonus<br>` +
               `• **Extra Returns**: +2% on all staking<br>` +
               `• **Zero Fees**: No withdrawal fees<br><br>` +
               `#### Monthly Salary Program:<br>` +
               `• **6+ Active Referrals**: $50/month<br>` +
               `• **13+ Active Referrals**: $110/month<br>` +
               `• **25+ Active Referrals**: $250/month<br><br>` +
               `🎯 **Your Referral Link**: {{ url_for('register', _external=True) }}?ref={{ current_user.referral_code }}`;
    }
    
    // Default response for unmatched queries
    return `### 🤖 Premium AI Assistant<br><br>` +
           `I'm here to help you with:<br><br>` +
           `#### Available Services:<br>` +
           `• **Account Analysis**: Complete portfolio overview<br>` +
           `• **Staking Guidance**: Investment strategies and tips<br>` +
           `• **Deposit Help**: Step-by-step funding process<br>` +
           `• **Withdrawal Support**: Cash-out procedures<br>` +
           `• **Referral Program**: Earning through referrals<br><br>` +
           `#### Quick Actions:<br>` +
           `• Type "account summary" for detailed analysis<br>` +
           `• Type "staking guide" for investment help<br>` +
           `• Type "human support" for live assistance<br><br>` +
           `💡 **Ask me anything about your investment journey!**`;
} +
               `**Stake #{{ stake.id }}** - {{ stake.coin.name }}<br>` +
               `• Amount: ${{ '%.2f'|format(stake.amount) }}<br>` +
               `• Daily Return: {{ stake.plan.interest_rate }}%<br>` +
               `• Days Remaining: {{ (stake.end_date - now).days if stake.end_date > now else 0 }}<br>` +
               `• Current Earnings: ${{ '%.2f'|format(stake.current_earnings) }}<br>` +
               `{% endfor %}<br>` +
               `#### Step 2: Performance Metrics<br>` +
               `• Total ROI: +15.8%<br>` +
               `• Best Performing Stake: USDT (1.5% daily)<br>` +
               `• Average Performance: 12.4%<br><br>` +
               `#### Step 3: Optimization Recommendations<br>` +
               `🎯 **Immediate Actions**:<br>` +
               `• Consider reinvesting earnings from completed stakes<br>` +
               `• Diversify into BTC for better returns<br>` +
               `• Aim for $500 total investment for premium tier<br><br>` +
               `✅ Your portfolio is performing excellently!`;
    }
    
    if (message.includes('deposit') && (message.includes('guide') || message.includes('process'))) {
        return `### 💰 Step-by-Step Deposit Guide<br><br>` +
               `#### Step 1: Preparation<br>` +
               `• Ensure you have USDT in your external wallet<br>` +
               `• Use BEP20 network (Binance Smart Chain) for lowest fees<br>` +
               `• Minimum deposit: $10<br><br>` +
               `#### Step 2: Get Deposit Address<br>` +
               `• Go to Assets → Deposit section<br>` +
               `• Copy wallet address: **0xae49d3b4775c0524bd81da704340b5ef5a7416e9**<br>` +
               `• Scan QR code for mobile convenience<br><br>` +
               `#### Step 3: Send USDT<br>` +
               `• Open your external wallet (Trust Wallet, MetaMask, etc.)<br>` +
               `• Select USDT (BEP20 network)<br>` +
               `• Paste deposit address<br>` +
               `• Enter amount and confirm transaction<br><br>` +
               `#### Step 4: Verify Transaction<br>` +
               `• Copy transaction hash from your wallet<br>` +
               `• Return to deposit page<br>` +
               `• Paste transaction hash for instant verification<br>` +
               `• Balance updated automatically upon blockchain confirmation<br><br>` +
               `⏱️ **Processing Time**: Usually 1-3 minutes<br>` +
               `🔒 **Security**: All transactions verified on blockchain`;
    }
    
    if (message.includes('strategy') || message.includes('optimize') || message.includes('investment')) {
        return `### 🧠 Personalized Investment Strategy<br><br>` +
               `#### Current Analysis:<br>` +
               `• Your Balance: ${{ '%.2f'|format(current_user.usdt_balance) }}<br>` +
               `• Risk Level: Moderate<br>` +
               `• Investment Goal: Growth with Premium Benefits<br><br>` +
               `#### Recommended Strategy:<br>` +
               `**Phase 1: Foundation Building**<br>` +
               `• Stake 70% in USDT (7-15 days) for stable returns<br>` +
               `• Stake 30% in BTC/ETH (30+ days) for higher growth<br><br>` +
               `**Phase 2: Growth Acceleration**<br>` +
               `• Reinvest completed stake earnings<br>` +
               `• Focus on building referral network (current: {{ current_user.get_referral_count() }})<br>` +
               `• Target 2+ referrals for premium benefits<br><br>` +
               `**Phase 3: Portfolio Optimization**<br>` +
               `• Diversify across 3-4 different coins<br>` +
               `• Mix short-term (7-15 days) and long-term (90+ days) stakes<br>` +
               `• Utilize compounding for exponential growth<br><br>` +
               `#### Expected Results (90 days):<br>` +
               `• Conservative Growth: +15-20%<br>` +
               `• With Referrals: +25-35%<br>` +
               `• Optimal Strategy: +35-50%<br><br>` +
               `🚀 **Start with**: $100 in USDT for stable growth`;
    }
    
    if (message.includes('withdrawal') || message.includes('withdraw')) {
        return `### 💸 Complete Withdrawal Process Guide<br><br>` +
               `#### Step 1: Check Eligibility<br>` +
               `• Minimum withdrawal: $10<br>` +
               `• Available balance: ${{ '%.2f'|format(current_user.usdt_balance) }}<br>` +
               `• Processing fee: 1% of amount<br><br>` +
               `#### Step 2: Prepare External Wallet<br>` +
               `• Ensure you have a USDT-compatible wallet<br>` +
               `• Verify wallet supports BEP20 or TRC20<br>` +
               `• Double-check wallet address<br><br>` +
               `#### Step 3: Submit Withdrawal<br>` +
               `• Go to Assets → Withdrawal<br>` +
               `• Enter withdrawal amount<br>` +
               `• Paste your wallet address<br>` +
               `• Select network (BEP20 recommended)<br>` +
               `• Review and confirm<br><br>` +
               `#### Step 4: Processing Timeline<br>` +
               `• Admin review: 2-24 hours<br>` +
               `• Blockchain confirmation: 5-10 minutes<br>` +
               `• Total time: Usually same day<br><br>` +
               `⚡ **Pro Tip**: Get 2 referrals to eliminate fees and get priority processing!`;
    }
    
    if (message.includes('referral') || message.includes('referrals')) {
        return `### 👥 Referral Program Performance Analysis<br><br>` +
               `#### Current Status:<br>` +
               `• Total Referrals: {{ current_user.get_referral_count() }}<br>` +
               `• Active Referrals: 2<br>` +
               `• Premium Status: {% if current_user.get_referral_count() >= 2 %}✅ Activated{% else %}❌ Need {{ 2 - current_user.get_referral_count() }} more{% endif %}<br><br>` +
               `#### Earnings Breakdown:<br>` +
               `• Level 1 Commission: 5%<br>` +
               `• Level 2 Commission: 3%<br>` +
               `• Level 3 Commission: 2%<br>` +
               `• Total Referral Earnings: $125.50<br><br>` +
               `#### Benefits Unlocked:<br>` +
               `{% if current_user.get_referral_count() >= 2 %}` +
               `✅ $20 Welcome Bonus<br>` +
               `✅ Extra 2% Staking Income<br>` +
               `✅ Zero Withdrawal Fees<br>` +
               `✅ Priority Support<br>` +
               `{% else %}` +
               `❌ $20 Welcome Bonus (Need {{ 2 - current_user.get_referral_count() }} more)<br>` +
               `❌ Extra 2% Staking Income<br>` +
               `❌ Zero Withdrawal Fees<br>` +
               `{% endif %}<br>` +
               `#### Monthly Salary Program:<br>` +
               `• 6+ Referrals: $50/month<br>` +
               `• 13+ Referrals: $110/month<br>` +
               `• 25+ Referrals: $250/month<br><br>` +
               `🎯 **Your Referral Link**:<br>` +
               `{{ url_for('register', referral_code=current_user.referral_code, _external=True) }}<br><br>` +
               `📈 **Growth Strategy**: Share on social media, forums, and with friends interested in crypto investing!`;
    }
    
    // Default enhanced responses
    const responses = {
        'help': [
            `### 🤝 How I Can Help You<br><br>` +
            `As your **Premium AI Assistant**, I provide:<br><br>` +
            `#### Instant Analysis:<br>` +
            `• Complete account summaries<br>` +
            `• Real-time performance tracking<br>` +
            `• Investment optimization<br><br>` +
            `#### Step-by-Step Guidance:<br>` +
            `• Deposit/withdrawal processes<br>` +
            `• Staking strategy planning<br>` +
            `• Referral program optimization<br><br>` +
            `#### Smart Recommendations:<br>` +
            `• Portfolio diversification<br>` +
            `• Risk management<br>` +
            `• Growth opportunities<br><br>` +
            `🎯 **Just ask**: "How to maximize returns?" or "Analyze my portfolio"`,
            
            `### 💡 Premium Support Features<br><br>` +
            `#### What Makes Us Different:<br>` +
            `• **AI-Powered**: Real-time data analysis<br>` +
            `• **Step-by-Step**: Detailed guidance for every action<br>` +
            `• **Personalized**: Strategies based on your portfolio<br>` +
            `• **Instant**: No waiting times<br><br>` +
            `#### Popular Requests:<br>` +
            `• "Show my investment performance"<br>` +
            `• "Best staking strategy for my balance"<br>` +
            `• "How to withdraw funds"<br>` +
            `• "Optimize my referral earnings"<br><br>` +
            `✨ **Pro Tip**: Be specific in your questions for the most detailed guidance!`
        ],
        'default': [
            `I understand you need assistance! As your **Premium AI Support**, I can provide detailed, step-by-step guidance on any topic.<br><br>` +
            `**Try asking me:**<br>` +
            `• "Analyze my account performance"<br>` +
            `• "Guide me through the deposit process"<br>` +
            `• "What's the best investment strategy?"<br>` +
            `• "How can I maximize my earnings?"<br><br>` +
            `I have access to your complete account data and can provide personalized recommendations! 🚀`,
            
            `Hello! I'm here to provide **premium-level support** with detailed analysis and step-by-step solutions.<br><br>` +
            `**Current Account Status:**<br>` +
            `• Balance: ${{ '%.2f'|format(current_user.usdt_balance) }}<br>` +
            `• Active Stakes: {{ current_user.stakes|length }}<br>` +
            `• Referrals: {{ current_user.get_referral_count() }}<br><br>` +
            `**How can I help optimize your investment journey today?** 💰`
        ]
    };
    
    let category = 'default';
    if (message.includes('help') || message.includes('support') || message.includes('assist')) {
        category = 'help';
    }
    
    const categoryResponses = responses[category];
    return categoryResponses[Math.floor(Math.random() * categoryResponses.length)];
}

// Auto-scroll and initialization
document.addEventListener('DOMContentLoaded', () => {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Animate welcome message
    setTimeout(() => {
        const welcomeMsg = messagesContainer.querySelector('.animate-fade-in');
        if (welcomeMsg) {
            welcomeMsg.style.opacity = '1';
        }
    }, 500);
});
</script>
{% endblock %}