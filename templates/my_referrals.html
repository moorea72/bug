{% extends "base.html" %}

{% block title %}My Referrals - Refer 2 Friends Program{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold gradient-heading">My Referrals</h1>
            <p class="text-gray-700 mt-2">Refer 2 friends and unlock premium benefits forever</p>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="copyReferralLink()" class="glass-button px-4 py-2 rounded-lg text-black">
                <i class="fas fa-copy mr-2"></i>Copy Referral Link
            </button>
            <a href="{{ url_for('home') }}" class="glass-button px-4 py-2 rounded-lg text-black">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </header>

    <!-- Deposit-Based Bonus System Info -->
    <div class="glass-card rounded-xl p-6 mb-8">
        <h3 class="text-xl font-bold text-black mb-4">Referral Bonus System</h3>
        <p class="text-gray-700 mb-6">Earn fixed bonuses when your referrals make deposits. Each referral can only generate one bonus.</p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="text-2xl font-bold text-green-600">100 USDT</div>
                <div class="text-lg font-semibold text-green-700">→ 7 USDT</div>
                <div class="text-sm text-gray-600">Bonus</div>
                <div class="text-xs text-gray-500">One-time per referral</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="text-2xl font-bold text-blue-600">150 USDT</div>
                <div class="text-lg font-semibold text-blue-700">→ 11 USDT</div>
                <div class="text-sm text-gray-600">Bonus</div>
                <div class="text-xs text-gray-500">One-time per referral</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div class="text-2xl font-bold text-purple-600">250 USDT</div>
                <div class="text-lg font-semibold text-purple-700">→ 22 USDT</div>
                <div class="text-sm text-gray-600">Bonus</div>
                <div class="text-xs text-gray-500">One-time per referral</div>
            </div>
        </div>

        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-gray-700">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                <strong>How it works:</strong> Share your referral link and earn bonuses when your friends deposit. The higher their deposit amount, the bigger your bonus! Each referral can only generate one bonus, so larger deposits are better.
            </p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-green-600 mb-2">{{ stats.active_referrals }}</div>
            <div class="text-sm text-gray-600">Active Referrals</div>
            <div class="text-xs text-gray-500 mt-1">(With deposits)</div>
        </div>

        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-blue-600 mb-2">{{ stats.total_referrals }}</div>
            <div class="text-sm text-gray-600">Total Referrals</div>
            <div class="text-xs text-gray-500 mt-1">(All registered users)</div>
        </div>

        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-purple-600 mb-2">${{ "%.2f"|format(stats.total_earned) }}</div>
            <div class="text-sm text-gray-600">Total Earned</div>
            <div class="text-xs text-gray-500 mt-1">(Deposit bonuses)</div>
        </div>

        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-orange-600 mb-2">{{ stats.bonus_count }}</div>
            <div class="text-sm text-gray-600">Bonuses Received</div>
            <div class="text-xs text-gray-500 mt-1">(One-time bonuses)</div>
        </div>

        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-purple-600 mb-2">${{ "%.2f"|format(stats.total_earned) }}</div>
            <div class="text-sm text-gray-600">Total Earned</div>
            <div class="text-xs text-gray-500 mt-1">(Deposit bonuses)</div>
        </div>

        <div class="glass-card p-6 rounded-xl text-center">
            <div class="text-3xl font-bold text-orange-600 mb-2">{{ stats.bonus_count }}</div>
            <div class="text-sm text-gray-600">Bonuses Received</div>
            <div class="text-xs text-gray-500 mt-1">(One-time bonuses)</div>
        </div>
    </div>

    <!-- Referral Code Section -->
    <div class="glass-card rounded-xl p-6 mb-8">
        <h3 class="text-xl font-bold text-black mb-4">Your Referral Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Referral Code</label>
                <div class="flex">
                    <input type="text" id="referralCode" value="{{ stats.referral_code }}" readonly 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50">
                    <button onclick="copyToClipboard('referralCode')" 
                            class="px-4 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Referral Link</label>
                <div class="flex">
                    <input type="text" id="referralLink" value="{{ stats.referral_link }}" readonly 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50 text-xs">
                    <button onclick="copyToClipboard('referralLink')" 
                            class="px-4 py-2 bg-green-500 text-white rounded-r-lg hover:bg-green-600">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Bonuses -->
    {% if recent_bonuses %}
    <div class="glass-card rounded-xl p-6 mb-8">
        <h3 class="text-xl font-bold text-black mb-4">Recent Bonuses</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-4 font-semibold text-black">Bonus</th>
                        <th class="text-left py-2 px-4 font-semibold text-black">Description</th>
                        <th class="text-left py-2 px-4 font-semibold text-black">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bonus in recent_bonuses %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-4 font-medium text-green-600">
                            {% set amount = bonus.description.split('$')[1].split(' ')[0] %}
                            ${{ amount }}
                        </td>
                        <td class="py-2 px-4 text-gray-700">{{ bonus.description }}</td>
                        <td class="py-2 px-4 text-gray-500 text-sm">{{ bonus.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Referral Details -->
    {% if referral_details %}
    <div class="glass-card rounded-xl p-6 mb-8">
        <h3 class="text-xl font-bold text-black mb-4">Your Referrals</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-4 font-semibold text-black">User</th>
                        <th class="text-left py-2 px-4 font-semibold text-black">Total Deposits</th>
                        <th class="text-left py-2 px-4 font-semibold text-black">Bonus Generated</th>
                        <th class="text-left py-2 px-4 font-semibold text-black">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in referral_details %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-4 font-medium text-black">{{ detail.user.username }}</td>
                        <td class="py-2 px-4 text-gray-700">${{ "%.2f"|format(detail.total_deposits) }}</td>
                        <td class="py-2 px-4">
                            {% if detail.bonus_generated > 0 %}
                                <span class="font-medium text-green-600">${{ "%.2f"|format(detail.bonus_generated) }}</span>
                            {% else %}
                                <span class="text-gray-400">$0.00</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-4">
                            {% if detail.bonus_generated > 0 %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Bonus Earned</span>
                            {% elif detail.total_deposits > 0 %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Has Deposits</span>
                            {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">No Deposits</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Referral Tree -->
    {% if referral_tree %}
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-xl font-bold text-black mb-4">Your Referral Tree</h3>
        <div id="referralTree" class="space-y-4">
            {% for level1 in referral_tree %}
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                            L1
                        </div>
                        <div>
                            <div class="font-medium text-black">{{ level1.user.username }}</div>
                            <div class="text-sm text-gray-600">
                                Balance: ${{ "%.2f"|format(level1.user.total_deposits) }}
                                {% if level1.user.is_eligible %}
                                <span class="text-green-600 ml-2">✓ Eligible</span>
                                {% else %}
                                <span class="text-red-600 ml-2">✗ Not Eligible</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium text-green-600">${{ "%.2f"|format(level1.commission_earned) }}</div>
                        <div class="text-xs text-gray-500">Commission Earned</div>
                    </div>
                </div>

                {% if level1.children %}
                <div class="ml-8 mt-4 space-y-3">
                    {% for level2 in level1.children %}
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                    L2
                                </div>
                                <div>
                                    <div class="font-medium text-black">{{ level2.user.username }}</div>
                                    <div class="text-sm text-gray-600">
                                        Balance: ${{ "%.2f"|format(level2.user.total_deposits) }}
                                        {% if level2.user.is_eligible %}
                                        <span class="text-green-600 ml-2">✓ Eligible</span>
                                        {% else %}
                                        <span class="text-red-600 ml-2">✗ Not Eligible</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium text-blue-600">${{ "%.2f"|format(level2.commission_earned) }}</div>
                                <div class="text-xs text-gray-500">Commission</div>
                            </div>
                        </div>

                        {% if level2.children %}
                        <div class="ml-6 mt-3 space-y-2">
                            {% for level3 in level2.children %}
                            <div class="border border-gray-200 rounded-lg p-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-5 h-5 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                            L3
                                        </div>
                                        <div>
                                            <div class="font-medium text-black text-sm">{{ level3.user.username }}</div>
                                            <div class="text-xs text-gray-600">
                                                Balance: ${{ "%.2f"|format(level3.user.total_deposits) }}
                                                {% if level3.user.is_eligible %}
                                                <span class="text-green-600 ml-1">✓</span>
                                                {% else %}
                                                <span class="text-red-600 ml-1">✗</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-medium text-purple-600 text-sm">${{ "%.2f"|format(level3.commission_earned) }}</div>
                                        <div class="text-xs text-gray-500">Commission</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="glass-card rounded-xl p-6 text-center">
        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-users text-gray-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-black mb-2">No Referrals Yet</h3>
        <p class="text-gray-600 mb-4">Start sharing your referral link to earn commissions!</p>
        <button onclick="copyReferralLink()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
            Copy Referral Link
        </button>
    </div>
    {% endif %}
</div>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    document.execCommand('copy');

    // Show success message
    const button = element.nextElementSibling;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.add('bg-green-500');
    button.classList.remove('bg-blue-500', 'bg-green-500');

    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('bg-green-500');
        button.classList.add(elementId === 'referralCode' ? 'bg-blue-500' : 'bg-green-500');
    }, 2000);
}

function copyReferralLink() {
    copyToClipboard('referralLink');
}
</script>
{% endblock %}